# language: yaml
- name: Deploy to EC2
  uses: appleboy/ssh-action@master
  env:
    IMAGE: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}
    SHA: ${{ github.sha }}
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ec2-user
    key: ${{ secrets.EC2_PEM_KEY }}
    script: |
      set -e
      cd ~/cohobby-server/cohobby
      git config core.filemode false || true
      git fetch origin main
      git reset --hard origin/main
      echo "Pull image $IMAGE:$SHA"
      sudo docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
      sudo docker pull $IMAGE:$SHA
      sed -i 's#image:.*#image: '"$IMAGE:$SHA"'#' docker-compose.yml
      sudo COMMIT_SHA=$SHA docker-compose up -d --force-recreate --pull always
      sudo docker image prune -f
      sudo docker ps --filter "name=cohobby-server"
      sudo docker inspect $IMAGE:$SHA | grep -i revision || true
